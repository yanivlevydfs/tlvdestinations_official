{% extends "base.html" %}

{% block title %}Ben Gurion Airport â€” Current Flight Statistics{% endblock %}

{% block head %}
<!-- Canonical & hreflang for /stats -->
<link rel="canonical" href="https://fly-tlv.com/stats" />
<link rel="alternate" hreflang="en" href="https://fly-tlv.com/stats" />
<link rel="alternate" hreflang="he" href="https://fly-tlv.com/stats?lang=he" />
<link rel="stylesheet" href="{{ url_for('static', path='css/app.css') }}?v={{ time.time() }}">

<!-- âœ… Page-specific SEO -->
<meta name="description"
  content="Live flight statistics from Ben Gurion Airport (TLV). Explore the top destinations, airlines, countries, and cities with departures and arrivals updated in real-time.">
<meta name="keywords"
  content="Ben Gurion Airport, TLV flights, flight statistics, top destinations, airlines, arrivals, departures, Tel Aviv flights">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="Ben Gurion Airport â€” Current Flight Statistics | Fly-TLV">
<meta property="og:description"
  content="See live statistics from Ben Gurion Airport (TLV). Explore top countries, cities, and airlines for departures and arrivals.">
<meta property="og:url" content="https://fly-tlv.com/stats">
<meta property="og:image" content="https://fly-tlv.com/static/og/flytlv_og.jpg">
<meta property="og:image:alt" content="Ben Gurion Airport TLV statistics dashboard">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Ben Gurion Airport â€” Current Flight Statistics | Fly-TLV">
<meta name="twitter:description"
  content="Live departures and arrivals statistics from TLV airport. Updated charts with top destinations and airlines.">
<meta name="twitter:image" content="https://fly-tlv.com/static/og/flytlv_og.jpg">
<meta name="twitter:image:alt" content="TLV airport stats overview">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "https://fly-tlv.com/#organization",
      "name": "Fly TLV",
      "url": "https://fly-tlv.com/",
      "logo": {
        "@type": "ImageObject",
        "url": "https://fly-tlv.com/static/icons/favicon-512.png",
        "width": 512,
        "height": 512
      },
      "sameAs": [
        "https://www.facebook.com/flytlv",
        "https://www.instagram.com/flytlv",
        "https://www.linkedin.com/company/flytlv"
      ]
    },
    {
      "@type": "WebSite",
      "@id": "https://fly-tlv.com/#website",
      "url": "https://fly-tlv.com/",
      "name": "Fly TLV â€” Direct Destinations from Tel Aviv",
      "publisher": { "@id": "https://fly-tlv.com/#organization" },
      "inLanguage": "en-US",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://fly-tlv.com/?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    },
    {
      "@type": "WebPage",
      "@id": "https://fly-tlv.com/stats#webpage",
      "url": "https://fly-tlv.com/stats",
      "name": "Airport Statistics â€” Fly TLV",
      "description": "View flight statistics, destination trends, airline frequencies, and traffic data for Tel Aviv Ben Gurion Airport (TLV).",
      "inLanguage": "en-US",
      "isPartOf": { "@id": "https://fly-tlv.com/#website" },
      "alternateLanguage": "https://fly-tlv.com/stats?lang=he",
      "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https://fly-tlv.com/"
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "Statistics",
            "item": "https://fly-tlv.com/stats"
          }
        ]
      }
    },
    {
      "@type": "ItemList",
      "@id": "https://fly-tlv.com/#navigation",
      "name": "Site Navigation",
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "item": { "@type": "SiteNavigationElement", "name": "Home", "url": "https://fly-tlv.com/" } },
        { "@type": "ListItem", "position": 2, "item": { "@type": "SiteNavigationElement", "name": "×‘×™×ª", "url": "https://fly-tlv.com/?lang=he" } },
        { "@type": "ListItem", "position": 3, "item": { "@type": "SiteNavigationElement", "name": "About", "url": "https://fly-tlv.com/about" } },
        { "@type": "ListItem", "position": 4, "item": { "@type": "SiteNavigationElement", "name": "×¢×œ×™× ×•", "url": "https://fly-tlv.com/about?lang=he" } }
      ]
    }
  ]
}
</script>
{% endblock %}

{% block content %}

<!-- Hero Section -->
<div class="hero-section text-center py-5 shadow-sm mb-4" lang="{{ lang }}"
  dir="{{ 'rtl' if lang == 'he' else 'ltr' }}">
  <div class="container position-relative z-1">
    <h1 class="fw-bold mb-2">
      {% if lang == 'he' %}
      ğŸ“Š × ×ª×•× ×™ ×˜×™×¡×•×ª ×¢×“×›× ×™×™× â€“ × ××œ ×ª×¢×•×¤×” ×‘×Ÿ ×’×•×¨×™×•×Ÿ
      {% else %}
      ğŸ“Š Ben Gurion Airport â€” Current Flight Statistics
      {% endif %}
    </h1>
    <div class="last-update-badge mt-2 d-inline-flex align-items-center">
      <i class="bi bi-clock-history"></i>
      <span class="label-text">
        {% if lang == 'he' %}×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”:{% else %}Last update:{% endif %}
      </span>
      <strong>{{ last_update[:16] if last_update and last_update != 'â€”' else last_update }}</strong>
    </div>
  </div>
</div>

<div class="container my-4" lang="{{ lang }}" dir="{{ 'rtl' if lang == 'he' else 'ltr' }}">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item">
        <a href="/{{ '' if lang != 'he' else '?lang=he' }}">
          {{ 'Home' if lang != 'he' else '×‘×™×ª' }}
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ 'Statistics' if lang != 'he' else '×¡×˜×˜×™×¡×˜×™×§×•×ª' }}
      </li>
    </ol>
  </nav>

  <!-- Kiwi / Travelpayouts Banner -->
  <div class="card mb-4 shadow-sm" aria-label="Advertisement">
    <div class="card-header small text-muted fw-semibold">
      <i class="bi bi-airplane-engines me-1 text-primary"></i>
      {% if lang == 'he' %} ×˜×™×¡×•×ª ×–×•×œ×•×ª {% else %} Cheap Flights {% endif %}
    </div>
    <div class="card-body text-center">
      <script async
        src="https://tpembd.com/content?currency=ils&trs=461563&shmarker=674907.kiwi_banner&locale=en&stops=any&show_hotels=true&powered_by=true&border_radius=30&plain=true&color_button=%232563eb&color_button_text=%23ffffff&promo_id=3414&campaign_id=111"
        charset="utf-8"></script>
    </div>
  </div>


  <style>
    /* Stats Custom Theme */
    .card-lowcost {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }

    .card-legacy {
      background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
    }

    .stats-card-inner {
      background: #ffffff;
      color: #1f2937;
      transition: background 0.3s, color 0.3s;
    }

    .text-adaptive {
      color: #111827;
    }

    /* Flags & Logos */
    .country-flag {
      width: 20px;
      height: 15px;
      object-fit: cover;
      border-radius: 2px;
      margin-inline-end: 8px;
      vertical-align: middle;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .airline-logo-small {
      width: 18px;
      height: 18px;
      object-fit: contain;
      margin-inline-end: 6px;
      vertical-align: middle;
    }

    .styled-table thead th {
      border-top: none;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    .styled-table tbody td {
      vertical-align: middle;
    }

    /* Dark Mode Overrides */
    body.dark-mode .card-lowcost {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      border: 1px solid rgba(56, 189, 248, 0.2) !important;
    }

    body.dark-mode .card-legacy {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      border: 1px solid rgba(167, 139, 250, 0.2) !important;
    }

    body.dark-mode .stats-card-inner {
      background: #1e293b;
      /* Slate-800 */
      color: #e2e8f0;
    }

    body.dark-mode .text-adaptive {
      color: #f3f4f6;
    }

    body.dark-mode .text-muted {
      color: #94a3b8 !important;
    }

    body.dark-mode .badge.bg-light.text-dark {
      background-color: #334155 !important;
      /* Slate-700 */
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
  </style>

  <div class="row g-4 mb-4">
    <!-- Low Cost Insights -->
    <div class="col-12 col-xl-6">
      <div class="card card-lowcost shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="stats-card-inner p-2 rounded-circle shadow-sm me-2">
              <i class="bi bi-wallet2 text-success fs-4"></i>
            </div>
            <h5 class="card-title fw-bold mb-0 text-adaptive">
              {% if lang == 'he' %}×ª×•×‘× ×•×ª ×œ×•××•-×§×•×¡×˜{% else %}Low-Cost Insights{% endif %}
            </h5>
          </div>

          <div class="row g-3 text-center">
            <!-- Count: Airlines -->
            <div class="col-6">
              <div class="stats-card-inner rounded p-3 shadow-sm h-100">
                <div class="text-muted small fw-bold text-uppercase mb-1">
                  {% if lang == 'he' %}×—×‘×¨×•×ª ×œ×•××•-×§×•×¡×˜{% else %}Low-Cost Airlines{% endif %}
                </div>
                <div class="fs-2 fw-bold text-primary">{{ lowcost_stats.count }}</div>
              </div>
            </div>

            <!-- Count: Destinations -->
            <div class="col-6">
              <div class="stats-card-inner rounded p-3 shadow-sm h-100">
                <div class="text-muted small fw-bold text-uppercase mb-1">
                  {% if lang == 'he' %}×™×¢×“×™ ×œ×•××•-×§×•×¡×˜{% else %}Low-Cost Destinations{% endif %}
                </div>
                <div class="fs-2 fw-bold text-success">{{ lowcost_stats.destinations_count }}</div>
              </div>
            </div>

            <!-- List: Airlines -->
            <div class="col-12 col-md-6">
              <div class="stats-card-inner rounded p-3 shadow-sm h-100 text-start">
                <div class="d-flex justify-content-between align-items-center mb-2" data-bs-toggle="collapse"
                  href="#collapseLCAirlines" role="button" aria-expanded="false" aria-controls="collapseLCAirlines"
                  style="cursor: pointer;">
                  <span class="text-muted small fw-bold text-uppercase">
                    {% if lang == 'he' %}×¨×©×™××ª ×—×‘×¨×•×ª{% else %}Airlines List{% endif %}
                  </span>
                  <i class="bi bi-chevron-down small"></i>
                </div>
                <div class="collapse" id="collapseLCAirlines">
                  <div class="d-flex flex-wrap gap-1" style="max-height: 100px; overflow-y: auto;">
                    {% for airline in lowcost_stats.airlines %}
                    <span class="badge bg-light text-dark border">{{ airline }}</span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

            <!-- List: Destinations -->
            <div class="col-12 col-md-6">
              <div class="stats-card-inner rounded p-3 shadow-sm h-100 text-start">
                <div class="d-flex justify-content-between align-items-center mb-2" data-bs-toggle="collapse"
                  href="#collapseLCDestinations" role="button" aria-expanded="false"
                  aria-controls="collapseLCDestinations" style="cursor: pointer;">
                  <span class="text-muted small fw-bold text-uppercase">
                    {% if lang == 'he' %}×¨×©×™××ª ×™×¢×“×™×{% else %}Destinations List{% endif %}
                  </span>
                  <i class="bi bi-chevron-down small"></i>
                </div>
                <div class="collapse" id="collapseLCDestinations">
                  <div class="d-flex flex-wrap gap-1" style="max-height: 100px; overflow-y: auto;">
                    {% for city in lowcost_stats.destinations %}
                    <span class="badge bg-light text-dark border">{{ city }}</span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Legacy / Full Service Insights -->
    <div class="col-12 col-xl-6">
      <div class="card card-legacy shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="stats-card-inner p-2 rounded-circle shadow-sm me-2">
              <i class="bi bi-airplane-engines text-primary fs-4"></i>
            </div>
            <h5 class="card-title fw-bold mb-0 text-adaptive">
              {% if lang == 'he' %}×—×‘×¨×•×ª ×¡×“×™×¨×•×ª / ××œ××•×ª{% else %}Legacy & Full-Service{% endif %}
            </h5>
          </div>

          <div class="row g-3 text-center">
            <!-- Count: Airlines -->
            <div class="col-6">
              <div class="stats-card-inner rounded p-3 shadow-sm h-100">
                <div class="text-muted small fw-bold text-uppercase mb-1">
                  {% if lang == 'he' %}×—×‘×¨×•×ª ×ª×¢×•×¤×”{% else %}Airlines{% endif %}
                </div>
                <div class="fs-2 fw-bold text-purple" style="color: #9333ea;">{{ legacy_stats.count }}</div>
              </div>
            </div>

            <!-- Count: Destinations -->
            <div class="col-6">
              <div class="stats-card-inner rounded p-3 shadow-sm h-100">
                <div class="text-muted small fw-bold text-uppercase mb-1">
                  {% if lang == 'he' %}×™×¢×“×™×{% else %}Destinations{% endif %}
                </div>
                <div class="fs-2 fw-bold text-danger">{{ legacy_stats.destinations_count }}</div>
              </div>
            </div>

            <!-- List: Airlines -->
            <div class="col-12 col-md-6">
              <div class="stats-card-inner rounded p-3 shadow-sm h-100 text-start">
                <div class="d-flex justify-content-between align-items-center mb-2" data-bs-toggle="collapse"
                  href="#collapseLegacyAirlines" role="button" aria-expanded="false"
                  aria-controls="collapseLegacyAirlines" style="cursor: pointer;">
                  <span class="text-muted small fw-bold text-uppercase">
                    {% if lang == 'he' %}×¨×©×™××ª ×—×‘×¨×•×ª{% else %}Airlines List{% endif %}
                  </span>
                  <i class="bi bi-chevron-down small"></i>
                </div>
                <div class="collapse" id="collapseLegacyAirlines">
                  <div class="d-flex flex-wrap gap-1" style="max-height: 100px; overflow-y: auto;">
                    {% for airline in legacy_stats.airlines %}
                    <span class="badge bg-light text-dark border">{{ airline }}</span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

            <!-- List: Destinations -->
            <div class="col-12 col-md-6">
              <div class="stats-card-inner rounded p-3 shadow-sm h-100 text-start">
                <div class="d-flex justify-content-between align-items-center mb-2" data-bs-toggle="collapse"
                  href="#collapseLegacyDestinations" role="button" aria-expanded="false"
                  aria-controls="collapseLegacyDestinations" style="cursor: pointer;">
                  <span class="text-muted small fw-bold text-uppercase">
                    {% if lang == 'he' %}×¨×©×™××ª ×™×¢×“×™×{% else %}Destinations List{% endif %}
                  </span>
                  <i class="bi bi-chevron-down small"></i>
                </div>
                <div class="collapse" id="collapseLegacyDestinations">
                  <div class="d-flex flex-wrap gap-1" style="max-height: 100px; overflow-y: auto;">
                    {% for city in legacy_stats.destinations %}
                    <span class="badge bg-light text-dark border">{{ city }}</span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Row -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <!-- Label -->
        <div class="col-12 col-md-auto">
          <label class="form-label fw-semibold mb-0">
            <i class="bi bi-funnel-fill text-primary me-1"></i>
            {% if lang == 'he' %}×¡×™× ×•×Ÿ ×œ×¤×™:{% else %}Filter by:{% endif %}
          </label>
        </div>

        <!-- 1. Airline Filter -->
        <div class="col-12 col-md">
          <select id="airline-filter" class="form-select" aria-label="Filter by Airline">
            <option value="All" selected>
              {% if lang == 'he' %}×—×‘×¨×ª ×ª×¢×•×¤×” (×”×›×œ){% else %}Airline (All){% endif %}
            </option>
            {% for airline in airlines %}
            <option value="{{ airline }}">{{ airline }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- 2. Country Filter -->
        <div class="col-12 col-md">
          <select id="country-filter" class="form-select" aria-label="Filter by Country">
            <option value="All" selected>
              {% if lang == 'he' %}××“×™× ×” (×”×›×œ){% else %}Country (All){% endif %}
            </option>
            {% for c in all_countries %}
            <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- 3. City Filter -->
        <div class="col-12 col-md">
          <select id="city-filter" class="form-select" aria-label="Filter by City">
            <option value="All" selected>
              {% if lang == 'he' %}×¢×™×¨ (×”×›×œ){% else %}City (All){% endif %}
            </option>
            {% for city in all_cities %}
            <option value="{{ city }}">{{ city }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- 4. Date/History Filter (DB Sourced) -->
        <div class="col-12 col-md">
          <select id="history-filter" class="form-select border-primary fw-semibold" aria-label="Filter by Date">
            <option value="" {% if not active_snapshot_id %}selected{% endif %}>
              ğŸ•’ {% if lang == 'he' %}×ª××¨×™×š: ×—×™ (×”×›×™ ×¢×“×›× ×™){% else %}Date: Live (Latest){% endif %}
            </option>
            {% for snap in available_snapshots %}
            <option value="{{ snap.id }}" {% if active_snapshot_id==snap.id %}selected{% endif %}>
              ğŸ“… {{ snap.timestamp[:16] }}
            </option>
            {% endfor %}
          </select>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Top Countries / Airlines -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-bold text-primary" id="left-chart-title">
        ğŸŒ {% if lang == 'he' %}×”××“×™× ×•×ª ×”××•×‘×™×œ×•×ª{% else %}Top Countries{% endif %}
      </div>
      <div class="card-body">
        <div class="table-responsive mb-3">
          <table id="left-table" class="styled-table table table-striped table-hover table-sm align-middle text-center">
            <thead class="table-primary">
              <tr>
                <th id="left-col-header">{% if lang == 'he' %}××“×™× ×”{% else %}Country{% endif %}</th>
                <th>{% if lang == 'he' %}×”××¨××•×ª{% else %}Departures{% endif %}</th>
                <th>{% if lang == 'he' %}× ×—×™×ª×•×ª{% else %}Arrivals{% endif %}</th>
              </tr>
            </thead>
            <tbody>
              {% for row in top_countries %}
              <tr>
                <td class="text-start ps-3">
                  {% set iso = country_iso_map.get(row.Country|lower, "") %}
                  {% if iso %}
                  <img src="https://flagcdn.com/24x18/{{ iso|lower }}.png" alt="{{ row.Country }}" class="country-flag">
                  {% endif %}
                  {{ row.Country }}
                </td>
                <td>{{ row.Departures }}</td>
                <td>{{ row.Arrivals }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="countries-chart" style="height:320px;"></div>
      </div>
    </div>
  </div>

  <!-- Top Cities / Airlines -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-bold text-primary" id="right-chart-title">
        ğŸ™ï¸ {% if lang == 'he' %}×”×¢×¨×™× ×”××•×‘×™×œ×•×ª{% else %}Top Cities{% endif %}
      </div>
      <div class="card-body">
        <div class="table-responsive mb-3">
          <table id="right-table"
            class="styled-table table table-striped table-hover table-sm align-middle text-center">
            <thead class="table-primary">
              <tr>
                <th id="right-col-header">{% if lang == 'he' %}×¢×™×¨{% else %}City{% endif %}</th>
                <th>{% if lang == 'he' %}×”××¨××•×ª{% else %}Departures{% endif %}</th>
                <th>{% if lang == 'he' %}× ×—×™×ª×•×ª{% else %}Arrivals{% endif %}</th>
              </tr>
            </thead>
            <tbody>
              {% for row in top_cities %}
              <tr>
                <td class="text-start ps-3">
                  {% set iso = country_iso_map.get(row.Country|lower, "") %}
                  {% if iso %}
                  <img src="https://flagcdn.com/24x18/{{ iso|lower }}.png" alt="{{ row.Country }}" class="country-flag"
                    title="{{ row.Country }}">
                  {% endif %}
                  {{ row.City }}
                </td>
                <td>{{ row.Departures }}</td>
                <td>{{ row.Arrivals }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="cities-chart" style="height:320px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Ads Under Table -->
<div class="row mt-4">
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100" aria-label="Advertisement">
      <div class="card-header small text-muted fw-semibold">
        <i class="bi bi-airplane-engines me-1 text-primary"></i>
        {% if lang == 'he' %} ××‘×¦×¢×™× ×¢×œ ×˜×™×¡×•×ª {% else %} Flight Deals {% endif %}
      </div>
      <div class="card-body text-center p-0 overflow-hidden">
        <script async
          src="https://tpembd.com/content?currency=ils&trs=461563&shmarker=674907.kiwi_under_tb1&locale=en&powered_by=true&limit=4&primary_color=0049AEff&results_background_color=FFFFFF&form_background_color=FFFFFF&promo_id=4563&campaign_id=111"
          charset="utf-8"></script>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6 mt-3 mt-md-0">
    <div class="card shadow-sm h-100" aria-label="Advertisement">
      <div class="card-header small text-muted fw-semibold">
        <i class="bi bi-airplane me-1 text-primary"></i>
        {% if lang == 'he' %} ×¡×™× ×–×•×œ {% else %} Cheap ESIM {% endif %}
      </div>
      <div class="card-body text-center p-0 overflow-hidden">
        <script async
          src="https://tpembd.com/content?trs=461563&shmarker=674907.kiwi_under_tb2&locale=en&powered_by=true&color_button=%230049AE&color_focused=%230049AE&secondary=%23FFFFFF&dark=%2311100f&light=%23FFFFFF&special=%23C4C4C4&border_radius=30&plain=false&no_labels=true&promo_id=8588&campaign_id=541"
          charset="utf-8"></script>
      </div>
    </div>
  </div>
</div>

</div>
{% endblock %}
{% block scripts %}
<script src="/static/js/lang.js?v={{ version }}"></script>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {

    // ---------- 1. Backend data ----------
    const airlinesData = {{ airlines_data | tojson | safe
  }};
  const countriesData = {{ countries_data | tojson | safe }};
  const citiesData = {{ cities_data | tojson | safe }};
  const initialCountries = {{ top_countries | tojson | safe }};
  const initialCities = {{ top_cities | tojson | safe }};
  const countryIsoMap = {{ country_iso_map | tojson | safe }};
  const airlineToCode = {{ airline_to_code | tojson | safe }};
  const lang = "{{ lang }}" || "en";

  // ---------- 2. Translations ----------
  const L = (window.LANG && window.LANG[lang]) ? window.LANG[lang] : (window.LANG ? window.LANG["en"] : {});

  const historyFilter = document.getElementById("history-filter");
  if (historyFilter) {
    historyFilter.addEventListener("change", function () {
      const val = this.value;
      const url = new URL(window.location.href);
      if (val) {
        url.searchParams.set("snapshot_id", val);
      } else {
        url.searchParams.delete("snapshot_id");
      }
      window.location.href = url.toString();
    });
  }

  const T = {
    Countries: L.countries || "Countries",
    Cities: L.cities || "Cities",
    Airlines: (L.table && L.table.airlines) ? L.table.airlines : "Airlines",
    TopCountries: L.topCountries || "Top Countries",
    TopCities: L.topCities || "Top Cities",
    Departures: L.departures || "Departures",
    Arrivals: L.arrivals || "Arrivals",
    Country: L.country || "Country",
    City: (L.table && L.table.city) ? L.table.city : "City",
    Airline: L.airline || "Airline"
  };

  // ---------- 3. DOM ----------
  const airlineSelect = document.getElementById("airline-filter");
  const countrySelect = document.getElementById("country-filter");
  const citySelect = document.getElementById("city-filter");

  // ---------- 4. Helpers ----------
  function resetSelects(exceptId) {
    if (airlineSelect && exceptId !== "airline-filter") airlineSelect.value = "All";
    if (countrySelect && exceptId !== "country-filter") countrySelect.value = "All";
    if (citySelect && exceptId !== "city-filter") citySelect.value = "All";
  }

  function getFlag(countryName) {
    if (!countryName) return "";
    // keys in countryIsoMap are lower-case or 2-letter codes
    var iso = countryIsoMap[countryName.toLowerCase()] || countryIsoMap[countryName];
    if (!iso) return "";
    return `<img src="https://flagcdn.com/24x18/${iso.toLowerCase()}.png" alt="${countryName}" class="country-flag">`;
  }

  function getLogo(airlineName) {
    if (!airlineName || !airlineToCode[airlineName]) return "";
    const code = airlineToCode[airlineName].toLowerCase();
    return `<img src="/static/airlines_logo/airline_logos/${code}.webp" alt="${airlineName}" class="airline-logo-small" onerror="this.style.display='none'">`;
  }

  function chartLayout() {
    return {
      barmode: "group",
      margin: { t: 30, r: 20, l: 40, b: 80 },
      legend: { orientation: "h", y: -0.3 },
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      font: {
        color: document.body.classList.contains("dark-mode")
          ? "#e5e5e5"
          : "#333"
      }
    };
  }

  // ---------- 5. Render ----------
  function renderCharts(leftData, leftLabel, rightData, rightLabel, leftKey, rightKey) {
    if (!leftData || !rightData) return;

    document.getElementById("left-chart-title").innerText = leftLabel;
    document.getElementById("right-chart-title").innerText = rightLabel;

    document.getElementById("left-col-header").innerText =
      leftKey === "Country" ? T.Country : leftKey === "Airline" ? T.Airline : T.City;

    document.getElementById("right-col-header").innerText =
      rightKey === "City" ? T.City : rightKey === "Country" ? T.Country : T.Airline;

    const depColor = "rgba(124,58,237,0.8)";
    const arrColor = "rgba(34,211,238,0.8)";

    Plotly.react("countries-chart", [
      { x: leftData.map(r => r[leftKey]), y: leftData.map(r => r.Departures), name: T.Departures, type: "bar", marker: { color: depColor } },
      { x: leftData.map(r => r[leftKey]), y: leftData.map(r => r.Arrivals), name: T.Arrivals, type: "bar", marker: { color: arrColor } }
    ], chartLayout(), { responsive: true });

    Plotly.react("cities-chart", [
      { x: rightData.map(r => r[rightKey]), y: rightData.map(r => r.Departures), name: T.Departures, type: "bar", marker: { color: depColor } },
      { x: rightData.map(r => r[rightKey]), y: rightData.map(r => r.Arrivals), name: T.Arrivals, type: "bar", marker: { color: arrColor } }
    ], chartLayout(), { responsive: true });

    // Render Left Table
    document.querySelector("#left-table tbody").innerHTML = leftData.map(r => {
      let labelHtml = r[leftKey];
      if (leftKey === "Country") {
        labelHtml = getFlag(r[leftKey]) + r[leftKey];
      } else if (leftKey === "Airline") {
        labelHtml = getLogo(r[leftKey]) + r[leftKey];
      } else if (leftKey === "City") {
        if (r.Country) labelHtml = getFlag(r.Country) + r[leftKey];
      }
      return `<tr><td class="text-start ps-3">${labelHtml}</td><td>${r.Departures}</td><td>${r.Arrivals}</td></tr>`;
    }).join("");

    // Render Right Table
    document.querySelector("#right-table tbody").innerHTML = rightData.map(r => {
      let labelHtml = r[rightKey];
      if (rightKey === "Country") {
        labelHtml = getFlag(r[rightKey]) + r[rightKey];
      } else if (rightKey === "Airline") {
        labelHtml = getLogo(r[rightKey]) + r[rightKey];
      } else if (rightKey === "City") {
        if (r.Country) labelHtml = getFlag(r.Country) + r[rightKey];
      }
      return `<tr><td class="text-start ps-3">${labelHtml}</td><td>${r.Departures}</td><td>${r.Arrivals}</td></tr>`;
    }).join("");
  }

  // ---------- 6. Update logic ----------
  function updateCharts(type) {
    let L, R, LK, RK, LL, RL;

    if (type === "Airline" && airlineSelect) {
      const v = airlineSelect.value;
      resetSelects("airline-filter");
      if (v === "All") {
        L = initialCountries; LK = "Country"; LL = T.TopCountries;
        R = initialCities; RK = "City"; RL = T.TopCities;
      } else if (airlinesData[v]) {
        L = airlinesData[v].countries; LK = "Country"; LL = `ğŸŒ ${T.Countries}`; // "Countries" for this Airline
        R = airlinesData[v].cities; RK = "City"; RL = `ğŸ™ï¸ ${T.Cities}`;       // "Cities" for this Airline
      }
    }

    if (type === "Country" && countrySelect) {
      const v = countrySelect.value;
      resetSelects("country-filter");
      if (v === "All") {
        L = initialCountries; LK = "Country"; LL = T.TopCountries;
        R = initialCities; RK = "City"; RL = T.TopCities;
      } else if (countriesData[v]) {
        L = countriesData[v].airlines; LK = "Airline"; LL = `âœˆï¸ ${T.Airlines}`;
        R = countriesData[v].cities; RK = "City"; RL = `ğŸ™ï¸ ${T.Cities}`;
      }
    }

    if (type === "City" && citySelect) {
      const v = citySelect.value;
      resetSelects("city-filter");
      if (v === "All") {
        L = initialCountries; LK = "Country"; LL = T.TopCountries;
        R = initialCities; RK = "City"; RL = T.TopCities;
      } else if (citiesData[v]) {
        L = citiesData[v].airlines; LK = "Airline"; LL = `âœˆï¸ ${T.Airlines}`;
        R = citiesData[v].countries; RK = "Country"; RL = `ğŸŒ ${T.Countries}`;
      }
    }

    if (L && R) renderCharts(L, LL, R, RL, LK, RK);
  }

  // ---------- 7. Events ----------
  airlineSelect?.addEventListener("change", () => updateCharts("Airline"));
  countrySelect?.addEventListener("change", () => updateCharts("Country"));
  citySelect?.addEventListener("change", () => updateCharts("City"));

  // ---------- 8. Initial ----------
  renderCharts(initialCountries, T.TopCountries, initialCities, T.TopCities, "Country", "City");
  });
</script>
{% endblock %}
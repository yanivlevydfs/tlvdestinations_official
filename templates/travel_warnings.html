{% extends "base.html" %}

{% block title %}אזהרות מסע — Fly TLV{% endblock %}

{% block content %}
<div class="container my-4 text-center">
  <h2 class="section-title">🌍 אזהרות מסע</h2>

  {% if last_update %}
    <div class="mb-3">
      <span class="badge rounded-pill bg-info px-3 py-2 text-dark">
        עודכן לאחרונה: {{ last_update | datetimeformat }}
      </span>
    </div>
  {% endif %}

  <!-- Search & Filter -->
  <div class="card shadow-sm mb-4 text-start">
    <div class="card-header fw-semibold">Search & Filter</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="continent-filter" class="form-label">יבשת</label>
          <select id="continent-filter" class="form-select">
            <option value="">הצג הכל</option>
            {% for c in continents %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="country-filter" class="form-label">מדינה</label>
          <select id="country-filter" class="form-select">
            <option value="">הצג הכל</option>
            {% for c in countries %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="level-filter" class="form-label">רמת איום</label>
          <select id="level-filter" class="form-select">
            <option value="">הצג הכל</option>
            <option value="גבוה">גבוה</option>
            <option value="בינוני">בינוני</option>
            <option value="נמוך">נמוך</option>
            <option value="לא ידוע">לא ידוע</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="query-filter" class="form-label">חיפוש חופשי</label>
          <input type="text" id="query-filter" class="form-control" placeholder="חיפוש בהמלצות, משרד...">
        </div>
      </div>

      <div class="border-top pt-3 mt-3 d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" id="clear-filters" aria-label="איפוס סינון">
          <i class="bi bi-x-circle me-1"></i> איפוס
        </button>
        <span class="ms-auto text-muted small" id="active-filters">ללא סינון</span>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm text-start">
    <div class="card-body">
      <table id="warnings-table" class="table table-striped table-hover w-100 align-middle">
        <thead class="table-primary">
          <tr>
            <th>יבשת</th>
            <th>מדינה</th>
            <th>רמת איום</th>
            <th>המלצות</th>
            <th>משרד</th>
            <th>לינק</th>
            <th>לוגו</th>
          </tr>
        </thead>
        <tbody>
          {% for w in warnings %}
          {% set level_value = (
            "High" if w.level == "High" else
            "Medium" if w.level == "Medium" else
            "Low" if w.level == "Low" else
            "Unknown"
          ) %}
          <tr>
            <td>{{ w.continent }}</td>
            <td>{{ w.country }}</td>
            <td>
              <span class="search-text d-none">{{ level_value }}</span>
              {% if level_value == "High" %}
                <span class="badge bg-danger">גבוה</span>
              {% elif level_value == "Medium" %}
                <span class="badge bg-warning text-dark">בינוני</span>
              {% elif level_value == "Low" %}
                <span class="badge bg-success">נמוך</span>
              {% else %}
                <span class="badge bg-secondary">לא ידוע</span>
              {% endif %}
            </td>
            <td>{{ w.recommendations }}</td>
            <td>{{ w.office or "—" }}</td>
            <td>
              {% if w.details_url %}
                <a href="{{ w.details_url }}" target="_blank" class="btn btn-sm btn-primary">פרטים</a>
              {% else %}—{% endif %}
            </td>
            <td>
              {% if w.logo and w.logo.src %}
                <img src="{{ w.logo.src }}" alt="{{ w.logo.alt or '' }}" style="height:24px;">
              {% else %}—{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Page title */
.section-title {
  text-align: center;
  font-weight: 700;
  font-size: 2rem;
  margin-bottom: 1.5rem;
  position: relative;
  display: inline-block;
  padding-bottom: 0.5rem;
}
.section-title::after {
  content: "";
  position: absolute;
  left: 50%;
  bottom: 0;
  transform: translateX(-50%);
  width: 60px;
  height: 4px;
  border-radius: 2px;
  background: linear-gradient(90deg, #7c3aed, #0ea5e9);
}

/* CSV & Column Visibility Buttons */
.dt-buttons .btn {
  margin-inline-end: 0.5rem;
}

/* Dark Mode Badge Fix */
body.dark-mode .badge.bg-info {
  color: #f8f9fa !important;
}

/* CSV Button (light & dark mode unified) */
.buttons-csv {
  background-color: #10b981;
  border-color: #10b981;
  color: white !important;
}
.buttons-csv:hover {
  background-color: #059669;
  border-color: #059669;
  color: white !important; /* ✅ force white text on hover */
}
body.dark-mode .buttons-csv {
  background-color: #10b981;
  border-color: #10b981;
  color: white !important;
}
body.dark-mode .buttons-csv:hover {
  background-color: #059669;
  border-color: #059669;
  color: white !important;
}

/* ColVis Button (light mode) */
.buttons-colvis {
  color: white !important;
  border-color: #3b82f6;
  background-color: #3b82f6;
}
.buttons-colvis:hover {
  background-color: #2563eb;
  border-color: #2563eb;
  color: white !important;
}

/* ColVis Button (dark mode) */
body.dark-mode .buttons-colvis {
  border-color: #3b82f6;
  color: white !important;   /* ✅ always white text */
  background-color: #3b82f6;
}
body.dark-mode .buttons-colvis:hover {
  background-color: #1e3a8a;
  color: white !important;   /* ✅ keep white text on hover */
}


</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const table = $('#warnings-table').DataTable({
    pageLength: 25,
    responsive: true,
    dom: 'Bfrtip',
    buttons: [
      {
        extend: 'csvHtml5',
        text: '<i class="bi bi-file-earmark-spreadsheet me-1"></i> ייצוא CSV',
        className: 'btn btn-success btn-sm buttons-csv'
      },
      {
        extend: 'colvis',
        text: '<i class="bi bi-eye me-1"></i> הצג/הסתר עמודות',
        className: 'btn btn-outline-primary btn-sm buttons-colvis'
      }
    ],
    language: {
      url: "{{ 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/he.json' if lang == 'he' else 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/en-GB.json' }}",
	  infoFiltered: ""
    },
    columnDefs: [{
      targets: 2,
      render: function (data, type, row, meta) {
        if (type === 'display') return data;
        const div = document.createElement('div');
        div.innerHTML = data;
        const hidden = div.querySelector('.search-text');
        return hidden ? hidden.textContent.trim() : '';
      }
    }]
  });

  // Update "Active Filters" label
  function updateActiveFilters() {
    const continent = $('#continent-filter').val();
    const country = $('#country-filter').val();
    const level = $('#level-filter').val();
    const query = $('#query-filter').val();

    let filters = [];
    if (continent) filters.push(`יבשת: ${continent}`);
    if (country) filters.push(`מדינה: ${country}`);
    if (level) filters.push(`רמת איום: ${level}`);
    if (query) filters.push(`חיפוש: ${query}`);

    $('#active-filters').text(filters.length ? filters.join(" | ") : "ללא סינון");
  }

  // Filters
  $('#continent-filter').on('change', function () {
    table.column(0).search(this.value || '').draw();
    updateActiveFilters();
  });

  $('#country-filter').on('change', function () {
    table.column(1).search(this.value || '').draw();
    updateActiveFilters();
  });

  $('#level-filter').on('change', function () {
    const map = {
      "גבוה": "High",
      "בינוני": "Medium",
      "נמוך": "Low",
      "לא ידוע": "Unknown"
    };
    const searchTerm = map[this.value] || '';
    table.column(2).search(searchTerm).draw();
    updateActiveFilters();
  });

  $('#query-filter').on('keyup change', function () {
    table.search(this.value).draw();
    updateActiveFilters();
  });

  $('#clear-filters').on('click', function () {
    $('#continent-filter, #country-filter, #level-filter').val('');
    $('#query-filter').val('');
    table.search('').columns().search('').draw();
    updateActiveFilters();
  });

  // Initial run
  updateActiveFilters();
});
</script>
{% endblock %}

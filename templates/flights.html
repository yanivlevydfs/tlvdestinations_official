{% extends "base.html" %}
{% block head %}
<link rel="canonical" href="https://fly-tlv.com/flights" />
<link rel="alternate" hreflang="en" href="https://fly-tlv.com/flights" />
<link rel="alternate" hreflang="he" href="https://fly-tlv.com/flights?lang=he" />
<link rel="stylesheet" href="{{ url_for('static', path='css/app.css') }}?v={{ time.time() }}">
<!-- DataTables Responsive CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<!-- DataTables Responsive JS -->
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<style>
  /* Prevent FOUC of table by hiding it before DataTables initializes */
  table.dataTable-pre-init {
    visibility: hidden;
    opacity: 0;
  }

  /* Smooth fade-in when JS removes dataTable-pre-init */
  table:not(.dataTable-pre-init) {
    animation: fadeInTable 0.5s ease-in forwards;
  }

  /* PREVENT PAGE JUMP: limit initial raw HTML rows to match DataTables pageLength (25) */
  table.dataTable-pre-init tbody tr:nth-child(n+26) {
    display: none !important;
  }

  @keyframes fadeInTable {
    from {
      opacity: 0;
      visibility: hidden;
    }

    to {
      opacity: 1;
      visibility: visible;
    }
  }

  /* Prevent jump when export buttons are injected */
  #export-buttons-desktop {
    min-height: 31px;
    opacity: 0;
    animation: fadeInTable 0.5s ease-in 0.1s forwards;
  }

  /* Force DataTables export buttons to stay on a single line */
  .dt-buttons {
    display: flex !important;
    flex-wrap: nowrap !important;
    flex-direction: row !important;
    align-items: center;
    gap: 0.5rem;
  }

  .dt-buttons .btn {
    white-space: nowrap !important;
    flex: 0 0 auto !important;
    width: auto !important;
  }
</style>

<!-- âœ… Page-specific SEO -->
<meta name="description"
  content="Live flight statistics from Ben Gurion Airport (TLV). Explore the top destinations, airlines, countries, and cities with departures and arrivals updated in real-time.">
<meta name="keywords"
  content="Ben Gurion Airport, TLV flights, flight statistics, top destinations, airlines, arrivals, departures, Tel Aviv flights">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="Ben Gurion Airport â€” Current Flight Statistics | Fly-TLV">
<meta property="og:description"
  content="See live statistics from Ben Gurion Airport (TLV). Explore top countries, cities, and airlines for departures and arrivals.">
<meta property="og:url" content="https://fly-tlv.com/flights">
<meta property="og:image" content="https://fly-tlv.com/static/og/flytlv_og.jpg">
<meta property="og:image:alt" content="Ben Gurion Airport TLV statistics dashboard">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Ben Gurion Airport â€” Current Flight Statistics | Fly-TLV">
<meta name="twitter:description"
  content="Live departures and arrivals statistics from TLV airport. Updated charts with top destinations and airlines.">
<meta name="twitter:image" content="https://fly-tlv.com/static/og/flytlv_og.jpg">
<meta name="twitter:image:alt" content="TLV airport stats overview">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [

    {
      "@type": "Organization",
      "@id": "https://fly-tlv.com/#organization",
      "name": "Fly TLV",
      "url": "https://fly-tlv.com/",
      "logo": {
        "@type": "ImageObject",
        "url": "https://fly-tlv.com/static/icons/favicon-512.png",
        "width": 512,
        "height": 512
      },
      "sameAs": [
        "https://www.facebook.com/flytlv",
        "https://www.instagram.com/flytlv",
        "https://www.linkedin.com/company/flytlv"
      ]
    },
    {
      "@type": "WebPage",
      "@id": "https://fly-tlv.com/flights#webpage",
      "url": "https://fly-tlv.com/flights",
      "name": "Flights from Tel Aviv â€” Fly TLV",
      "description": "Scheduled and direct flights from Tel Aviv Ben Gurion Airport (TLV).",
      "inLanguage": "en-US",
      "isPartOf": { "@id": "https://fly-tlv.com/#website" },
      "alternateLanguage": "https://fly-tlv.com/flights?lang=he",
      "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https://fly-tlv.com/"
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "Flights",
            "item": "https://fly-tlv.com/flights"
          }
        ]
      }
    }

  ]
}
</script>

{% endblock %}
{% block content %}

<!-- Hero Section -->
<div class="hero-section text-center py-5 shadow-sm mb-4" lang="{{ lang }}"
  dir="{{ 'rtl' if lang == 'he' else 'ltr' }}">
  <div class="container position-relative z-1">
    <h1 class="fw-bold mb-2 wow-header-text" style="font-size: clamp(2rem, 5vw, 3.5rem);">
      <i class="bi bi-airplane-engines me-2"></i>
      {{ 'Ben Gurion Airport Flight Schedule' if lang != 'he' else '×œ×•×— ×˜×™×¡×•×ª â€” × ××œ ×ª×¢×•×¤×” ×‘×Ÿ ×’×•×¨×™×•×Ÿ' }}
    </h1>
    <div class="last-update-badge mt-2 d-inline-flex align-items-center">
      <i class="bi bi-clock-history"></i>
      {{ 'Last update:' if lang != 'he' else '×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”:' }}
      <strong>{{ last_update }}</strong>
    </div>
  </div>
</div>

<div class="container-fluid px-3 px-lg-5" lang="{{ lang }}" dir="{{ 'rtl' if lang == 'he' else 'ltr' }}">
  <!-- ğŸ” Filter Card (Redesigned to match index.html) -->
  <div class="card shadow-sm mb-4 filter-wow">
    <div class="card-header fw-semibold header-title-desktop {{ 'rtl' if lang == 'he' else 'ltr' }}">
      <div class="d-flex align-items-center">
        <i class="bi bi-funnel-fill me-2 text-primary icon-glow"></i>
        <span class="wow-header-text">
          {{ 'Search & Filter' if lang != 'he' else '×—×™×¤×•×© ×•×¡×™× ×•×Ÿ' }}
        </span>
        <i class="bi bi-info-circle ms-auto text-muted" data-bs-toggle="tooltip" data-bs-placement="right"
          title="{{ 'Filter flight results by various criteria' if lang != 'he' else '×¡× ×Ÿ ××ª ×ª×•×¦××•×ª ×”×˜×™×¡×” ×œ×¤×™ ×§×¨×™×˜×¨×™×•× ×™× ×©×•× ×™×' }}"></i>
      </div>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-end">

        <!-- ğŸ” Search -->
        <div class="col-12 col-md-4 col-lg-3">
          <label for="flights-search-input" class="form-label mb-1">
            {{ 'Search' if lang != 'he' else '×—×™×¤×•×©' }}
          </label>
          <div class="query-wrapper position-relative">
            <i class="bi bi-search search-icon-inner"></i>
            <input type="search" id="flights-search-input" class="form-control premium-input"
              placeholder="{{ 'Flight, Airline, City...' if lang != 'he' else '×˜×™×¡×”, ×—×‘×¨×ª ×ª×¢×•×¤×”, ×¢×™×¨...' }}">
          </div>
        </div>

        <!-- ğŸ›« Direction -->
        <div class="col-6 col-md-2">
          <label for="direction-filter" class="form-label mb-1">{{ 'Direction' if lang != 'he' else
            '×›×™×•×•×Ÿ' }}</label>
          <select id="direction-filter" class="form-select premium-input">
            <option value="">{{ 'All' if lang != 'he' else '×”×›×œ' }}</option>
            <option value="Departure">{{ 'Departure' if lang != 'he' else '×”××¨××”' }}</option>
            <option value="Arrival">{{ 'Arrival' if lang != 'he' else '× ×—×™×ª×”' }}</option>
          </select>
        </div>

        <!-- ğŸš¦ Status -->
        <div class="col-6 col-md-2">
          <label for="status-filter" class="form-label mb-1">{{ 'Status' if lang != 'he' else '×¡×˜×˜×•×¡'
            }}</label>
          <select id="status-filter" class="form-select premium-input">
            <option value="">{{ 'All' if lang != 'he' else '×”×›×œ' }}</option>
            <option value="On Time">{{ 'On Time' if lang != 'he' else '×‘×–××Ÿ' }}</option>
            <option value="Delayed">{{ 'Delayed' if lang != 'he' else '×‘×¢×™×›×•×‘' }}</option>
            <option value="Cancelled">{{ 'Cancelled' if lang != 'he' else '×‘×•×˜×œ×”' }}</option>
            <option value="Not Final">{{ 'Not Final' if lang != 'he' else '×œ× ×¡×•×¤×™' }}</option>
          </select>
        </div>

        <!-- ğŸŒ Country -->
        <div class="col-6 col-md-2">
          <label for="country-filter" class="form-label mb-1">{{ 'Country' if lang != 'he' else '××“×™× ×”'
            }}</label>
          <select id="country-filter" class="form-select premium-input">
            <option value="">{{ 'All' if lang != 'he' else '×”×›×œ' }}</option>
            {% for country in countries %}
            <option value="{{ country }}">{{ country }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- ğŸ¢ Terminal -->
        <div class="col-6 col-md-2">
          <label for="terminal-filter" class="form-label mb-1">{{ 'Terminal' if lang != 'he' else '×˜×¨××™× ×œ'
            }}</label>
          <select id="terminal-filter" class="form-select premium-input">
            <option value="">{{ 'All' if lang != 'he' else '×”×›×œ' }}</option>
            {% for t in terminals %}
            <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- ğŸ“… Date -->
        <div class="col-6 col-md-3 col-lg-2">
          <label for="actual-date-filter" class="form-label mb-1">{{ 'Date' if lang != 'he' else '×ª××¨×™×š'
            }}</label>
          <select id="actual-date-filter" class="form-select premium-input">
            <option value="">{{ 'All' if lang != 'he' else '×”×›×œ' }}</option>
            {% for value, label in actual_dates %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- ğŸ•’ Time -->
        <div class="col-6 col-md-3 col-lg-2">
          <label for="actual-time-filter" class="form-label mb-1">{{ 'Time' if lang != 'he' else '×©×¢×”'
            }}</label>
          <select id="actual-time-filter" class="form-select premium-input">
            <option value="">{{ 'All' if lang != 'he' else '×”×›×œ' }}</option>
            {% for t in actual_times %}
            <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- ğŸ’° Lowcost Filter -->
        <div class="col-6 col-md-3 col-lg-auto d-flex align-items-end mb-1">
          <div
            class="form-check form-switch p-0 d-flex align-items-center justify-content-between premium-switch-container"
            style="min-height: 2.2rem;">
            <label class="form-check-label small fw-semibold me-2" for="lowcost-checkbox">
              <i class="bi bi-tag-fill me-1 text-primary"></i>
              {{ 'Low-cost only' if lang != 'he' else '×œ×•××•-×§×•×¡×˜ ×‘×œ×‘×“' }}
            </label>
            <input class="form-check-input ms-0" type="checkbox" id="lowcost-checkbox" role="switch">
          </div>
        </div>

      </div> <!-- row -->

      <!-- Desktop Export Buttons & Clear Filters Row -->
      <div class="row mt-3 pt-3 border-top align-items-center">
        <!-- Left Side: Export Buttons & Legend -->
        <div class="col-12 col-md-8 d-none d-md-flex flex-row align-items-center gap-3">
          <div id="export-buttons-desktop" class="d-flex">
            <!-- DataTables buttons injected here -->
          </div>
          <!-- Static Legend -->
          <div class="d-flex align-items-center small text-muted">
            <span class="lowcost-dot" style="margin-bottom: 2px;"></span>
            <span class="ms-1">{{ 'Low-cost airline' if lang != 'he' else '×œ×•××•-×§×•×¡×˜' }}</span>
          </div>
        </div>
        <!-- Right Side: Clear Filters Button -->
        <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
          <button class="btn btn-wow-clear py-2 px-4 shadow-sm" id="clear-filters" aria-label="Clear all filters">
            <i class="bi bi-x-circle me-1"></i>
            {{ 'Clear Filters' if lang != 'he' else '× ×§×” ××¡× × ×™×' }}
          </button>
        </div>
      </div>

    </div> <!-- card-body -->
  </div> <!-- card -->

  <!-- Main Glass Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="table-responsive">
        <table id="flightsTable" class="table table-striped table-hover w-100 align-middle dataTable-pre-init"
          aria-label="Table of flights">
          <thead class="table-primary">
            <tr>
              <th class="d-md-none"></th> <!-- âœ… Responsive control column -->
              <th scope="col">{{ 'Airline' if lang != 'he' else '×—×‘×¨×ª ×ª×¢×•×¤×”' }}</th>
              <th scope="col">{{ 'Flight No.' if lang != 'he' else '××¡×¤×¨ ×˜×™×¡×”' }}</th>
              <th scope="col">IATA</th>
              <th scope="col">{{ 'Airport' if lang != 'he' else '×©×“×” ×ª×¢×•×¤×”' }}</th>
              <th scope="col">{{ 'City' if lang != 'he' else '×¢×™×¨' }}</th>
              <th scope="col">{{ 'Country' if lang != 'he' else '××“×™× ×”' }}</th>
              <th scope="col">{{ 'Scheduled' if lang != 'he' else '××ª×•×›× × ×ª' }}</th>
              <th scope="col">{{ 'Actual' if lang != 'he' else '×©×¢×ª × ×—×™×ª×”/×”××¨××”' }}</th>
              <th scope="col">{{ 'Terminal' if lang != 'he' else '×˜×¨××™× ×œ' }}</th>
              <th scope="col">{{ 'Direction' if lang != 'he' else '×›×™×•×•×Ÿ' }}</th>
              <th scope="col">{{ 'Status' if lang != 'he' else '×¡×˜×˜×•×¡' }}</th>
            </tr>
          </thead>
          <tbody>
            {% for flight in flights %}
            <tr>
              <td class="dtr-control d-md-none"></td>
              <td class="airline-cell">
                {% if flight.airline and flight.airline != "â€”" %}
                {% set airline_list = flight.airline.split(',') %}
                {% set code_list = flight.airline_code.split(',') if flight.airline_code else [] %}

                {% for airline in airline_list %}
                {% set airline_name = airline.strip().title() %}
                {% set website = AIRLINE_WEBSITES.get(airline_name) %}
                {% set current_code = code_list[loop.index0].strip() if code_list and loop.index0 < code_list|length
                  else '' %} {% set is_lowcost=flight.airline_lowcost[loop.index0] if flight.airline_lowcost and
                  loop.index0 < flight.airline_lowcost|length else False %} {%- if website -%} <a href="{{ website }}"
                  target="_blank" rel="noopener" class="airline-chip text-decoration-none fw-semibold"
                  title="Visit {{ airline_name | e }} website">
                  {% if current_code %}
                  <img src="/static/airlines_logo/airline_logos/{{ current_code|lower }}.webp" alt="{{ airline_name }}"
                    onerror="this.onerror=null;this.src='/static/airlines_logo/airline_logos/default.webp';"
                    class="airline-logo-sm me-1" style="height: 16px; width: auto; vertical-align: middle;">
                  {% endif %}
                  {% if is_lowcost %}
                  <span class="lowcost-dot" style="margin-right: 4px; margin-left: 2px;"></span>
                  {% endif %}
                  {{ airline_name }}
                  <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.85em;"></i>
                  </a>
                  {%- else -%}
                  <a href="https://www.google.com/search?q={{ airline_name | urlencode }}" target="_blank"
                    rel="noopener" class="airline-chip text-decoration-none fw-semibold"
                    title="Search for {{ airline_name | e }} on Google">
                    {% if current_code %}
                    <img src="/static/airlines_logo/airline_logos/{{ current_code|lower }}.webp"
                      alt="{{ airline_name }}"
                      onerror="this.onerror=null;this.src='/static/airlines_logo/airline_logos/default.webp';"
                      class="airline-logo-sm me-1" style="height: 16px; width: auto; vertical-align: middle;">
                    {% endif %}
                    {% if is_lowcost %}
                    <span class="lowcost-dot" style="margin-right: 4px; margin-left: 2px;"></span>
                    {% endif %}
                    {{ airline_name }}
                    <i class="bi bi-search ms-1" style="font-size: 0.85em;"></i>
                  </a>
                  {%- endif -%}
                  {% endfor %}
                  {% else %}
                  â€”
                  {% endif %}
              </td>
              <td>
                <span class="wow-flight-badge" title="{{ flight.flight_number }}">
                  {%- if flight.airline_code -%}
                  {%- set codes = flight.airline_code.split(',') -%}
                  {%- if codes|length > 0 and codes[0].strip() -%}
                  {{ codes[0].strip().upper() }}
                  {%- endif -%}
                  {%- endif -%}
                  {{ flight.flight_number }}
                </span>
              </td>
              <td>{{ flight.iata }}</td>
              <td>{{ flight.airport if lang != 'he' else (flight.airport_name_he if flight.airport_name_he else
                flight.airport) }}</td>
              <td><a href="/destinations/{{ flight.iata }}" class="text-decoration-none fw-bold">{{ flight.city if lang
                  != 'he' else (flight.city_he if flight.city_he else flight.city) }}</a>
              </td>
              <td>{{ flight.country if lang != 'he' else (flight.country_he if flight.country_he else flight.country) }}
              </td>
              <!-- Scheduled -->
              <td title="{{ flight.scheduled_full if flight.scheduled_full else '' }}">
                {% if flight.scheduled_full %}
                <time datetime="{{ flight.scheduled_full }}">{{ flight.scheduled }}</time>
                {% else %}
                â€”
                {% endif %}
              </td>

              <!-- Actual -->
              <td title="{{ flight.actual_full if flight.actual_full else '' }}">
                {% if flight.actual_iso %}
                <span class="d-none">{{ flight.actual_iso }}</span> {# ğŸ‘ˆ this makes ISO searchable #}
                <time datetime="{{ flight.actual_iso }}">{{ flight.actual }}</time>
                {% else %}
                â€”
                {% endif %}
              </td>
              <td>
                {{ flight.terminal if flight.terminal else 'â€”' }}
              </td>
              <td>
                {% if flight.direction == "D" %}
                <span class="flight-status-badge badge bg-primary"> {{ 'Departure' if lang != 'he' else '×”××¨××”' }}
                </span>
                {% elif flight.direction == "A" %}
                <span class="flight-status-badge badge bg-success"> {{ 'Arrival' if lang != 'he' else '× ×—×™×ª×”' }} </span>
                {% else %} â€” {% endif %}
              </td>
              <td>
                {% set s = flight.status|lower %}
                {% if "on time" in s %}
                <span class="flight-status-badge badge bg-success">{{ 'On Time' if lang != 'he' else '×‘×–××Ÿ' }}</span>
                {% elif "delay" in s %}
                <span class="flight-status-badge badge bg-warning text-dark">{{ 'Delayed' if lang != 'he' else '×‘×¢×™×›×•×‘'
                  }}</span>
                {% elif "cancel" in s %}
                <span class="flight-status-badge badge bg-danger">{{ 'Cancelled' if lang != 'he' else '×‘×•×˜×œ×”' }}</span>
                {% elif "not final" in s %}
                <span class="flight-status-badge badge bg-secondary text-white">{{ 'Not Final' if lang != 'he' else '×œ×
                  ×¡×•×¤×™' }}</span>
                {% elif "landed" in s %}
                <span class="flight-status-badge badge bg-info text-dark">{{ 'Landed' if lang != 'he' else '× ×—×ª×”'
                  }}</span>
                {% elif "departed" in s %}
                <span class="flight-status-badge badge bg-info text-dark">{{ 'Departed' if lang != 'he' else '×”××¨××”'
                  }}</span>
                {% elif "boarding" in s %}
                <span class="flight-status-badge badge bg-primary text-white">{{ 'Boarding' if lang != 'he' else '×¢×œ×™×™×”
                  ×œ××˜×•×¡' }}</span>
                {% elif "gate closed" in s %}
                <span class="flight-status-badge badge bg-secondary text-white">{{ 'Gate Closed' if lang != 'he' else
                  '×©×¢×¨ × ×¡×’×¨' }}</span>
                {% elif "scheduled" in s %}
                <span class="flight-status-badge badge bg-light text-dark">{{ 'Scheduled' if lang != 'he' else '××ª×•×›× × ×ª'
                  }}</span>
                {% elif "unknown" in s %}
                <span class="flight-status-badge badge bg-dark text-white">{{ 'Unknown' if lang != 'he' else '×œ× ×™×“×•×¢'
                  }}</span>
                {% else %}
                <span class="flight-status-badge badge bg-info text-dark">{{ flight.status }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Kiwi / Travelpayouts Banner -->
<div class="container-fluid px-2 px-md-3">
  <div class="card mt-4 shadow-sm" aria-label="Advertisement">
    <div class="card-header small text-muted fw-semibold">
      <i class="bi bi-airplane-engines me-1 text-primary"></i>Flight Search
    </div>
    <div class="card-body text-center">
      <script async
        src="https://tpembd.com/content?currency=ils&trs=461563&shmarker=674907.flight_bannerindex&show_hotels=true&powered_by=true&locale={{ 'he' if lang == 'he' else 'en' }}&searchUrl=www.aviasales.com%2Fsearch&primary_override=%2332a8dd&color_button=%2332a8dd&color_icons=%2332a8dd&dark=%23262626&light=%23FFFFFF&secondary=%23FFFFFF&special=%23C4C4C400&color_focused=%2332a8dd&border_radius=19&no_labels=true&plain=true&origin=TLV&promo_id=7879&campaign_id=100"
        charset="utf-8"></script>
    </div>
  </div>
</div>

<div class="card shadow-sm d-none d-lg-block mt-4 mb-4 mx-3 mx-lg-5" aria-label="Advertisement">
  <div class="card-header small text-muted fw-semibold">
    <i class="bi bi-sim-fill me-1 text-primary"></i>{{ 'Travel SIM Deals' if lang != 'he' else '×¢×¡×§××•×ª ×¡×™× ×œ×—×•×´×œ' }}
  </div>
  <div class="card-body text-center p-0" style="overflow: hidden;">
    <script async
      src="https://tpembd.com/content?trs=461563&shmarker=674907.destinationsim&locale={{ 'he' if lang == 'he' else 'en' }}&powered_by=true&color_button=%2332a8dd&color_focused=%2332a8dd&secondary=%23FFFFFF&dark=%23262626&light=%23FFFFFF&special=%2300000000&border_radius=0&plain=false&no_labels=true&promo_id=8588&campaign_id=541"
      charset="utf-8">
      </script>
  </div>
</div>

<div class="container-fluid px-2 px-md-3 mb-5">
  <div class="card mt-3 shadow-sm" aria-label="Advertisement">
    <div class="card-header small text-muted fw-semibold">
      <i class="bi bi-airplane me-1 text-primary"></i>Flight Cancelled or Delayed?
    </div>
    <div class="card-body text-center p-0">
      <script async
        src="https://tpembd.com/content?trs=461563&shmarker=674907.airhelp_left_1&lang=en&powered_by=true&campaign_id=120&promo_id=8679"
        charset="utf-8"></script>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}

<script>
  $(document).ready(function () {
    const lang = "{{ lang }}";

    const dtButtons = lang === "he"
      ? [
        { extend: 'copyHtml5', text: '<i class="bi bi-clipboard me-1"></i> ×”×¢×ª×§' },
        { extend: 'csvHtml5', text: '<i class="bi bi-filetype-csv me-1"></i> CSV' },
        { extend: 'excelHtml5', text: '<i class="bi bi-file-earmark-excel me-1"></i> Excel' },
      ]
      : [
        { extend: 'copyHtml5', text: '<i class="bi bi-clipboard me-1"></i> Copy' },
        { extend: 'csvHtml5', text: '<i class="bi bi-filetype-csv me-1"></i> CSV' },
        { extend: 'excelHtml5', text: '<i class="bi bi-file-earmark-excel me-1"></i> Excel' },
      ];

    const table = $('#flightsTable').DataTable({
      dom:
        "<'row align-items-center'<'col-12 col-md-auto ms-auto dt-search-hidden'f>>" +
        "<'row'<'col-12'tr>>" +
        "<'row mt-3 px-3 align-items-center'<'col-sm-12 col-md-5 small text-muted text-center text-md-start mb-2 mb-md-0'i><'col-sm-12 col-md-7 d-flex justify-content-center justify-content-md-end'p>>",
      buttons: [
        {
          extend: 'copyHtml5',
          text: '<i class="bi bi-clipboard"></i> ' + (lang === "he" ? '×”×¢×ª×§' : 'Copy'),
          className: 'btn btn-wow-copy px-4 py-2'
        },
        {
          extend: 'csvHtml5',
          text: '<i class="bi bi-filetype-csv"></i> CSV',
          className: 'btn btn-wow-csv px-4 py-2'
        },
        {
          extend: 'excelHtml5',
          text: '<i class="bi bi-file-earmark-excel"></i> Excel',
          className: 'btn btn-wow-excel px-4 py-2'
        }
      ],
      pageLength: 25,
      responsive: {
        details: {
          type: 'column',
          target: 0
        }
      },

      order: [[7, 'asc']],
      pagingType: "simple",
      language: {
        url: lang === "he" ? "/static/js/lang.js" : "",
        infoFiltered: ""
      },
      columnDefs: [
        { targets: 0, className: 'dtr-control', orderable: false, searchable: false },

        { targets: 1, responsivePriority: 1 },   // Airline
        { targets: 2, responsivePriority: 2 },   // Flight No
        { targets: 11, responsivePriority: 1 },  // Status
        { targets: 9, responsivePriority: 2 },   // Terminal
        { targets: 7, responsivePriority: 2 },   // Scheduled
        { targets: 8, responsivePriority: 2 },   // Actual
        { targets: 10, responsivePriority: 3 },  // Direction

        { targets: [3, 4, 5, 6], responsivePriority: 100 }
      ],

      initComplete: function () {
        const api = this.api();
        // --- Move Export Buttons to Desktop Container and fix pill layout ---
        api.buttons().container().removeClass('btn-group flex-wrap').addClass('d-flex flex-nowrap gap-2').appendTo('#export-buttons-desktop');

        // --- Hide Default DataTables Filter ---
        $('.dt-search-hidden').hide();

        // --- Bind Search Input ---
        $('#flights-search-input').on('keyup search input', function () {
          api.search(this.value).draw();
        });

        // Remove pre-init class to prevent FOUC and trigger fade-in animation
        $('#flightsTable').removeClass('dataTable-pre-init');

        // --- Helper: Get Column Index by Header Text ---
        const getColumnIndexByHeader = (headerText) => {
          let found = -1;
          $('#flightsTable thead th').each(function (i) {
            if ($(this).text().trim() === headerText.trim()) {
              found = i;
              return false;
            }
          });
          return found;
        };

        // --- Bind Dropdown Filters ---

        // 1. Direction
        $('#direction-filter').on('change', function () {
          let sel = this.value;
          if (lang === "he" && sel) {
            sel = { "Departure": "×”××¨××”", "Arrival": "× ×—×™×ª×”" }[sel] || sel;
          }
          const header = lang === "he" ? "×›×™×•×•×Ÿ" : "Direction";
          const idx = getColumnIndexByHeader(header);
          if (idx !== -1) {
            api.column(idx).search(sel ? '^\\s*' + $.fn.dataTable.util.escapeRegex(sel) + '\\s*$' : '', true, false).draw();
          }
        });

        // 2. Status
        $('#status-filter').on('change', function () {
          let sel = this.value;
          if (lang === "he" && sel) {
            sel = { "On Time": "×‘×–××Ÿ", "Delayed": "×‘×¢×™×›×•×‘", "Cancelled": "×‘×•×˜×œ×”", "Not Final": "×œ× ×¡×•×¤×™" }[sel] || sel;
          }
          const header = lang === "he" ? "×¡×˜×˜×•×¡" : "Status";
          const idx = getColumnIndexByHeader(header);
          if (idx !== -1) {
            api.column(idx).search(sel ? '^\\s*' + $.fn.dataTable.util.escapeRegex(sel) + '\\s*$' : '', true, false).draw();
          }
        });

        // 3. Country
        $('#country-filter').on('change', function () {
          const header = lang === "he" ? "××“×™× ×”" : "Country";
          const idx = getColumnIndexByHeader(header);
          if (idx !== -1) api.column(idx).search(this.value ? '^\\s*' + $.fn.dataTable.util.escapeRegex(this.value) + '\\s*$' : '', true, false).draw();
        });

        // 4. Terminal
        $('#terminal-filter').on('change', function () {
          const idx = getColumnIndexByHeader(lang === "he" ? "×˜×¨××™× ×œ" : "Terminal");
          if (idx !== -1) api.column(idx).search(this.value ? '^\\s*' + $.fn.dataTable.util.escapeRegex(this.value) + '\\s*$' : '', true, false).draw();
        });

        // 5. Date & Time (Combined Logic)
        $('#actual-date-filter, #actual-time-filter').on('change', function () {
          const date = $.fn.dataTable.util.escapeRegex($('#actual-date-filter').val());
          const time = $.fn.dataTable.util.escapeRegex($('#actual-time-filter').val());

          const headerName = lang === "he" ? "×©×¢×ª × ×—×™×ª×”/×”××¨××”" : "Actual";
          const idx = getColumnIndexByHeader(headerName);

          let regex = "";
          if (date && time) {
            regex = `^${date}T${time}`;
          } else if (date) {
            regex = `^${date}`;
          } else if (time) {
            regex = `${time}$`;
          }

          if (idx !== -1) {
            api.column(idx).search(regex, true, false).draw();
          }
        });
        // 6. Lowcost Filter
        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
          if (settings.nTable.id !== 'flightsTable') return true;

          const isLowcostChecked = $('#lowcost-checkbox').is(':checked');
          if (!isLowcostChecked) return true;

          const apiLocal = new $.fn.dataTable.Api(settings);
          const rowNode = apiLocal.row(dataIndex).node();
          const hasDot = $(rowNode).find('.lowcost-dot').length > 0;
          return hasDot;
        });

        $('#lowcost-checkbox').on('change', function () {
          api.draw();
        });

        // --- Clear Filters ---
        $('#clear-filters').on('click', function () {
          $('#direction-filter').val('');
          $('#status-filter').val('');
          $('#country-filter').val('');
          $('#terminal-filter').val('');
          $('#actual-date-filter').val('');
          $('#actual-time-filter').val('');
          $('#lowcost-checkbox').prop('checked', false);
          $('#flights-search-input').val('');
          api.search('').columns().search('').draw();
        });
      }
    });

  });
</script>


{% endblock %}